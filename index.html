<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Reservas Temporarias</title>

<!-- Google APIs -->
<script async defer src="https://apis.google.com/js/api.js"></script>
<!-- NUEVO: Google Identity Services -->
<script async defer src="https://accounts.google.com/gsi/client"
        onload="onGisLoaded()"></script>

<style>
/* ======  CSS  ====== */
html,body{margin:0;padding:0;font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;color:#333}
.header{display:flex;flex-wrap:wrap;align-items:center;gap:8px;background:#2c3e50;color:#ecf0f1;padding:8px 12px}
.property-btn{background:#34495e;color:#ecf0f1;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:.9rem}
.property-btn.active{background:#1abc9c}
.action-btn{background:#2980b9;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:.9rem}
.action-btn.secondary{background:#7f8c8d}
.action-btn.danger{background:#c0392b}
.month-nav{margin-left:auto;display:flex;gap:4px;align-items:center}
.month-label{min-width:120px;text-align:center}
main{padding:10px}
.check-list{background:#fff;border:1px solid #ddd;border-radius:4px;padding:8px;font-size:.9rem;min-height:60px}
.badge{display:inline-block;padding:2px 4px;font-size:.7rem;border-radius:3px;margin-right:4px}
.badge-success{background:#81c784}.badge-danger{background:#e57373;color:#fff}
.calendar{overflow-x:auto;margin-top:15px}
table{border-collapse:collapse;width:100%;table-layout:fixed}
th,td{border:1px solid #ddd;padding:2px;vertical-align:top;font-size:.7rem;height:85px}
th:nth-child(1){background:#f28c8c;color:#fff}
th:nth-child(2){background:#e7b97d;color:#fff}
th:nth-child(3){background:#cfe3a1}
th:nth-child(4){background:#f1e9a1}
th:nth-child(5){background:#a0c1e8}
th:nth-child(6){background:#b79ddb;color:#fff}
th:nth-child(7){background:#cc8bc7;color:#fff}
.date-number{font-weight:bold;font-size:.8rem}
.event{display:block;margin-top:2px;padding:1px 2px;border-radius:3px;line-height:1.1;word-break:break-word}
.status-pending{background:#ffe082}.status-paid{background:#81c784}.status-cancelled{background:#e57373;color:#fff;text-decoration:line-through}
.hidden{display:none !important}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000}
.modal-content{background:#fff;padding:18px;border-radius:6px;width:90%;max-width:600px;max-height:90vh;overflow:auto}
.modal-content h2{margin-top:0}
.reservation-form{display:flex;flex-direction:column;gap:8px}
.reservation-form input,.reservation-form select{padding:6px;border:1px solid #ccc;border-radius:4px;font-size:.9rem}
.modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
</style>
</head>

<body>
<header class="header">
  <button class="property-btn active" id="btnBeltran4" onclick="switchCalendar('beltran4')">Beltrán 4º</button>
  <button class="property-btn" id="btnBeltran8" onclick="switchCalendar('beltran8')">Beltrán 8º</button>
  <button class="property-btn" id="btnDirectorio8" onclick="switchCalendar('directorio8')">Directorio 8º</button>

  <div class="month-nav">
    <button class="action-btn secondary" onclick="changeMonth(-1)">«</button>
    <span id="monthLabel" class="month-label"></span>
    <button class="action-btn secondary" onclick="changeMonth(1)">»</button>
  </div>

  <button class="action-btn" onclick="openModal()">Añadir reserva</button>

  <!-- Google Drive / GIS -->
  <button id="authBtn" class="action-btn secondary" onclick="handleAuthClick()" disabled>Iniciar sesión Google</button>
  <button id="signoutBtn" class="action-btn secondary hidden" onclick="handleSignoutClick()">Cerrar sesión</button>
</header>

<main>
  <h3>Check-ins / Check-outs</h3>
  <div id="checkList" class="check-list"></div>

  <div class="calendar">
    <div id="cal-beltran4"></div>
    <div id="cal-beltran8" class="hidden"></div>
    <div id="cal-directorio8" class="hidden"></div>
  </div>
</main>

<footer style="text-align:right;padding:8px">
  <button class="action-btn" onclick="exportData()">Exportar CSV</button>
</footer>

<!-- Modal (sin cambios) -->
<div id="modalOverlay" class="modal-overlay hidden">
  <div class="modal-content">
    <h2 id="modalTitle">Nueva reserva</h2>
    <form id="reservationForm" class="reservation-form">
      <select id="propertySelect" required>
        <option value="beltran4">Beltrán 4º</option>
        <option value="beltran8">Beltrán 8º</option>
        <option value="directorio8">Directorio 8º</option>
      </select>
      <input id="guestName" placeholder="Nombre del huésped" required />
      <input id="numGuests" type="number" min="1" placeholder="Cantidad de personas" required />
      <input id="checkInDate" type="date" required />
      <input id="checkOutDate" type="date" required />
      <input id="totalAmount" type="number" step="0.01" placeholder="Monto total" required />
      <input id="paidAmount" type="number" step="0.01" placeholder="Monto pagado" required />
      <input id="dueAmount" type="number" step="0.01" placeholder="Monto a pagar en ingreso" required />
      <select id="statusSelect">
        <option value="pending">Pendiente</option>
        <option value="paid">Pagado</option>
        <option value="cancelled">Cancelado</option>
      </select>
      <input type="hidden" id="reservationId" />
    </form>
    <div class="modal-actions">
      <button id="deleteBtn" class="action-btn danger hidden" onclick="handleDelete()">Eliminar</button>
      <button class="action-btn secondary" onclick="closeModal()">Cerrar</button>
      <button class="action-btn" onclick="handleSave()">Guardar</button>
    </div>
  </div>
</div>

<!-- ==========  JS  ========== -->
<script>
/* ---------- 1. Configuración Google (Drive + GIS) ---------- */
const CLIENT_ID  = '698390297082-afegco16qaslcs1va27jk1bt8davfu9k.apps.googleusercontent.com';
const API_KEY    = 'AIzaSyBhdQaa0zSGFnZclfl6ZQQsrPi3GXeBrrw';
const FILE_ID    = '1hLYO3OsFwXizfAoKXwVyNsf8Otj0b1Tn';           // tu JSON
const SCOPES     = 'https://www.googleapis.com/auth/drive.file';
const DISCOVERY  = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';

let tokenClient, gapiInited = false, gisInited = false;

function onGisLoaded(){               // se llama al cargar GIS
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: (r) => {
      if (r.error) {console.error(r); return;}
      gapi.client.setToken(r); readData(); updateSigninStatus(true);
    }
  });
  gisInited = true; maybeEnable();
}

function handleAuthClick(){ tokenClient.requestAccessToken({prompt:'consent'}); }
function handleSignoutClick(){
  const tok = gapi.client.getToken();
  if (tok) google.accounts.oauth2.revoke(tok.access_token, ()=>{});
  gapi.client.setToken(''); updateSigninStatus(false);
}

function updateSigninStatus(signed){
  authBtn.classList.toggle('hidden', signed);
  signoutBtn.classList.toggle('hidden', !signed);
}

function maybeEnable(){ if (gapiInited && gisInited) authBtn.disabled = false; }

/* ---------- 2. Carga del SDK de Drive ---------- */
function handleClientLoad(){
  gapi.load('client', async()=>{
    await gapi.client.init({apiKey:API_KEY, discoveryDocs:[DISCOVERY]});
    gapiInited = true; maybeEnable();
  });
}
window.addEventListener('load', handleClientLoad);

/* ---------- 3. Leer y guardar archivo JSON ---------- */
let reservas = [];

function readData(){
  gapi.client.drive.files.get({fileId:FILE_ID, alt:'media'})
      .then(r => { reservas = Array.isArray(r.result)? r.result : []; renderAll(); })
      .catch(e => console.error('Error leyendo Drive', e));
}

function save(){
  const body = JSON.stringify(reservas);
  gapi.client.request({
    path:`/upload/drive/v3/files/${FILE_ID}`,
    method:'PATCH',
    params:{uploadType:'media'},
    body
  }).catch(e => console.error('Error guardando', e));
}

/* ---------- 4.  Lógica de calendario (la tuya, intacta) ---------- */
const monthNames=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
let currentMonth=new Date().getMonth(), currentYear=new Date().getFullYear(), currentProp='beltran4';

function switchCalendar(prop){currentProp=prop;document.querySelectorAll('.property-btn').forEach(b=>b.classList.remove('active'));document.getElementById('btn'+prop.charAt(0).toUpperCase()+prop.slice(1)).classList.add('active');renderAll();}
function changeMonth(delta){currentMonth+=delta;if(currentMonth<0){currentMonth=11;--currentYear;}if(currentMonth>11){currentMonth=0;++currentYear;}renderAll();}
function monthLabel(){document.getElementById('monthLabel').textContent=monthNames[currentMonth]+' '+currentYear;}
function renderAll(){monthLabel();drawCalendar();updateList();}
function daysInMonth(){return new Date(currentYear,currentMonth+1,0).getDate();}

function drawCalendar(){
  const target=document.getElementById('cal-'+currentProp);
  document.querySelectorAll('.calendar > div').forEach(d=>d.classList.add('hidden')); target.classList.remove('hidden');
  let html='<table><thead><tr>'+['Lu','Ma','Mi','Ju','Vi','Sa','Do'].map(d=>'<th>'+d+'</th>').join('')+'</tr></thead><tbody>';
  const firstW=(new Date(currentYear,currentMonth,1).getDay()+6)%7,dias=daysInMonth();
  let d=1; for(let w=0;w<6;++w){html+='<tr>';
    for(let j=0;j<7;++j){
      if(w===0&&j<firstW||d>dias){html+='<td></td>';continue;}
      const fecha=`${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      html+=`<td><span class="date-number">${d}</span>`+
            reservas.filter(r=>r.property===currentProp&&fecha>=r.checkIn&&fecha<=r.checkOut)
                    .map(r=>`<span class="event status-${r.status}" onclick="openEdit('${r.id}')">${r.guestName}<br>$${r.total}</span>`).join('')+
            '</td>';++d;}
    html+='</tr>'; if(d>dias)break;}
  target.innerHTML=html+'</tbody></table>';
}

function updateList(){
  const list=document.getElementById('checkList'); list.innerHTML='';
  const hoy=new Date().toISOString().slice(0,10),mañana=new Date(Date.now()+864e5).toISOString().slice(0,10);
  [['Hoy',hoy],['Mañana',mañana]].forEach(([lbl,ds])=>{
    const inArr=reservas.filter(r=>r.property===currentProp&&r.checkIn===ds);
    const outArr=reservas.filter(r=>r.property===currentProp&&r.checkOut===ds);
    const sec=document.createElement('div'); sec.innerHTML=`<strong>${lbl} (${ds})</strong><br>`;
    if(!inArr.length&&!outArr.length) sec.append('Sin movimientos');
    if(inArr.length) sec.innerHTML+=`<span class="badge badge-success">Check-in</span> ${inArr.map(r=>r.guestName).join(', ')}<br>`;
    if(outArr.length)sec.innerHTML+=`<span class="badge badge-danger">Check-out</span> ${outArr.map(r=>r.guestName).join(', ')}`;
    list.appendChild(sec);
  });
}

function openModal(pref){modalOverlay.classList.remove('hidden');reservationForm.reset();reservationId.value='';deleteBtn.classList.add('hidden');if(pref){propertySelect.value=pref.property;checkInDate.value=pref.date;checkOutDate.value=pref.date;}}
function closeModal(){modalOverlay.classList.add('hidden');}
function handleSave(){
  const id=reservationId.value||'res-'+Math.random().toString(36).slice(2);
  const r={id,property:propertySelect.value,guestName:guestName.value.trim(),numGuests:+numGuests.value,
           checkIn:checkInDate.value,checkOut:checkOutDate.value,total:+totalAmount.value,
           paid:+paidAmount.value,due:+dueAmount.value,status:statusSelect.value};
  if(!r.guestName||!r.checkIn||!r.checkOut){alert('Faltan campos');return;}
  if(new Date(r.checkOut)<new Date(r.checkIn)){alert('Egreso debe ser ≥ ingreso');return;}
  reservas=reservas.filter(x=>x.id!==id); reservas.push(r); save(); renderAll(); closeModal();
}
function openEdit(id){const r=reservas.find(x=>x.id===id); if(!r)return; openModal(); modalTitle.textContent='Editar reserva';
  Object.assign(propertySelect,{value:r.property});guestName.value=r.guestName;numGuests.value=r.numGuests;
  checkInDate.value=r.checkIn;checkOutDate.value=r.checkOut;totalAmount.value=r.total;paidAmount.value=r.paid;
  dueAmount.value=r.due;statusSelect.value=r.status;reservationId.value=r.id;deleteBtn.classList.remove('hidden');}
function handleDelete(){const id=reservationId.value;if(id&&confirm('¿Eliminar la reserva?')){reservas=reservas.filter(r=>r.id!==id);save();renderAll();closeModal();}}
function exportData(){if(!reservas.length){alert('No hay datos');return;}const csv=['ID,Prop,Nombre,Pers,In,Egr,Total,Pago,Pend,Estado'];reservas.forEach(r=>csv.push([r.id,r.property,r.guestName,r.numGuests,r.checkIn,r.checkOut,r.total,r.paid,r.due,r.status].join(',')));const blob=new Blob([csv.join('\n')],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='reservas.csv';a.click();URL.revokeObjectURL(url);}

/* Exponer funciones globales (botones / inline-handlers) */
window.switchCalendar=switchCalendar;window.changeMonth=changeMonth;
window.openModal=openModal;window.closeModal=closeModal;
window.handleSave=handleSave;window.handleDelete=handleDelete;
window.handleAuthClick=handleAuthClick;window.handleSignoutClick=handleSignoutClick;
</script>

<script>monthLabel();renderAll();</script>
</body>
</html>

